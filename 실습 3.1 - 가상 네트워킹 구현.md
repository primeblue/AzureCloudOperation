# 실습 3.1 - 가상 네트워킹 구현

## 랩 시나리오

Azure 가상 네트워킹 기능을 살펴보십시오. 우선 Azure에 가상 네트워크를 생성하여 Azure 가상 시스템 몇 개를 호스팅할 것입니다. 네트워크 기반 분할을 구현할 예정이므로 가상 네트워크의 다른 서브넷에 배포하십시오. 또한 시간이 지남에 따라 개인 IP 주소와 공용 IP 주소가 변경되지 않도록 하십시오. Contoso 보안 요구 사항을 준수하려면 인터넷에서 액세스할 수 있는 Azure 가상 시스템의 공용 엔드포인트를 보호해야 합니다. 마지막으로 가상 네트워크와 인터넷에서 모두 Azure 가상 시스템에 DNS 이름 확인을 구현해야 합니다.

## 목표

이 과정에서, 우리는 다음과 같은 실습을 합니다 :

- 작업 1: 가상 네트워크 생성 및 구성
- 작업 2: 가상 네트워크에 가상 머신 배포
- 작업 3: Azure 가상 머신의 사설 및 공용 IP 주소 설정
- 작업 4: 네트워크 보안 그룹 구성
- 작업 5: 내부 이름 확인을 위한 Azure DNS 구성
- 작업 6: 외부 이름 확인을 위한 Azure DNS 구성

## 설명

### 작업 1: 가상 네트워크 생성 및 구성

이 작업에서는 Azure 포털을 사용해 다수의 서브넷이 있는 가상 네트워크를 만듭니다.

1. [Azure portal](https://portal.azure.com/)에 로그인한다.

2. Azure 포털에서 **가상 네트워크**를 찾아 선택한다. **가상 네트워크** 블레이드에서 **+ 추가**를 클릭한다.

3. 다음 설정을 사용하여 가상 네트워크를 만든다. (다른 값은 기본 설정을 사용한다)

   | 설정             | 값                                 |
   | ---------------- | ---------------------------------- |
   | 구독             | 이 랩에서 사용할 Azure 구독의 이름 |
   | 리소스 그룹      | 새로만들기 userxxRG                |
   | 이름             | **userxx-vnet1**                   |
   | 지역             | 한국중부                           |
   | IPv4 주소 공간   | **10.XX.0.0/20**                   |
   | 서브넷 이름      | **userxx-subnet1**                 |
   | 서브넷 주소 범위 | **10.xx.0.0/24**                   |

   > **참고:** 가상 네트워크가 프로비전될 때까지 기다리십시오. 이 작업은 1분 미만 소요됩니다.

4. **가상 네트워크** 블레이드에서 **새로 고침**을 하고, userxx-vnet1**을 클릭한다.

5. **userxx-vnet1** 가상 네트워크 블레이드에서 **서브넷**을 선택하고, **+ 서브넷**을 클릭한다.

6. 다음 설정을 사용하여 서브넷을 만든다. (다른 값은 기본 설정을 사용한다)

   | 설정                  | 값                 |
   | --------------------- | ------------------ |
   | Name                  | **userxx-subnet2** |
   | 주소 범위 (CIDR 블록) | **10.xx.1.0/24**   |
   | 네트워크 보안 그룹    | **없음**           |
   | 경로 테이블           | **없음**           |

7. 만들기를 클릭하여 새로운 가상네트워크를 생성한다.

### 작업 2: 가상 네트워크에 가상 머신 배포



1. 가상서버 생성한다.

   1. 리소스 그룹: user00RG
   2. 가상머신이름 : user00VM01, user00VM02
   3. 지역: 한국중부
   4. 이미지: ubuntu server 18.04 LTS
   5. 크기: standard_DS2_v2
   6. 관리자계정 : 암호
      1. 사용자이름: azureadmin
      2. 암호: Password!234
      3. 인바운트포트: 선택한 포트허용 ( ssh(22))
   7. 디스크 : 표준HDD
   8. 네트워킹
      1. 가상네트워크 : userxx-vnet01
      2. 서브넷 :  user00-subnet1(10.0.0.0/24) , user00-subnet2(10.0.1.0/24 )
      3. 공용 IP : 새로생성 
      4. 네트워크보안그룹: 기본선택
      5. 공용인바운드포트: 선택한포트허용(ssh)
   9. 관리: 부트진단( 끄기)
   10. 검토+만들기 를 통해 각각 두개의 가상서버를 생성한다. 

   

### 작업 3: Azure 가상 머신의 사설 및 공용 IP 주소 확인하고 정정설정가능

이 작업에서는 Azure 가상 머신의 네트워크 인터페이스에 사설 및 공용 IP 주소확인합니다.

> **참고**: 개인 및 공용 IP 주소는 실제로 네트워크 인터페이스에 할당되며, 이는 다시 Azure 가상 머신에 연결됩니다. Azure 가상 머신에 할당된 IP 주소를 참조하는 것은 매우 일반적입니다.

1. Azure 포털에서 **리소스 그룹**을 검색하고 선택한다. **리소스 그룹** 블레이드에서 userxxRG를 클릭한다.

2. userxxRG 리소스 그룹 블레이드의 리소스 리스트에서 **userxx-vnet1**을 클릭한다.

3. userxx-vnet1 가상 네트워크 블레이드의 **연결된 디바이스** 섹션에서 두개의 네트워크 인터페이스 userxxvm01xx 와 userxxvm02xx를 확인한다.

4. userxxvm01xx를 클릭하고, userxxvm01 블레이드에서 **IP 구성**을 클릭한다.

   > **참고**: 현재 **ipconfig1**이 동적 IP 주소로 설정되어 있는 것을 확인하십시오.

5. IP 구성 리스트에서 **ipconfig1**을 클릭한다.

6. **ipconfig1** 블레이드에서 **할당**을 **정적**으로 바꾸고, 기본으로 설정된 **IP 주소** 값 **10.xx.0.4**을 입력하고 저장을 클릭한다.

7. **ipconfig1** 블레이드에서 **공용 IP 주소**를 **연결**로 설정하고 **IP 주소 - 필수 설정 구성**을 클릭한다.

8. **userxxRG** 리소스 그룹 블레이드로 돌아가서 userxxvm01을 클릭한다. 가상 머신 블레이드에서 공용 IP 주소를 메모해둔다.

9. **userxxRG** 리소스 그룹 블레이드에서 userxxvm02을 클릭한다.  가상 머신 블레이드에서 공용 IP 주소를 메모해둔다.

   > **참고**: 두 IP 주소를 이 랩의 마지막 단계에 사용할 예정입니다.

### 작업 4: 내부 이름 확인을 위한 Azure DNS 구성

이 작업에서는 Azure 프라이빗 DNS 영역을 이용하여 가상 네트워크 내의 DNS 이름 확인을 구성합니다.

1. Azure 포털에서 **프라이빗 DNS 영역**을 찾아 선택한다. **프라이빗 DNS 영역** 블레이드에서 **+ 추가**를 클릭한다.

2. 다음 설정을 사용하여 프라이빗 DNS 영역을 구성한다. (다른 값은 기본 설정을 사용한다)

   | 구성        | 값                                 |
   | ----------- | ---------------------------------- |
   | 구독        | 이 랩에서 사용할 Azure 구독의 이름 |
   | 리소스 그룹 | userxxRG                           |
   | 이름        | userxx.org                         |

   > **참고**: 프라이빗 DNS 영역이 만들어질 때까지 기다리십시오. 이 작업은 약 2분 소요됩니다.

3. **리소스로 이동**을 클릭해 usexx.org 프라이빗 DNS 영역으로 이동한다.

4. userxx.org 프라이빗 DNS 영역 블레이드에서 **설정** 섹션의 **가상 네트워크 링크**를 클릭한다.

5. 다음 설정을 사용하여 가상 네트워크 링크를 추가한다. (다른 값은 기본 설정을 사용한다)

   | 구성           | 값                                 |
   | -------------- | ---------------------------------- |
   | 링크 이름      | **userxx-vnet1-link**              |
   | 구독           | 이 랩에서 사용할 Azure 구독의 이름 |
   | 가상 네트워크  | userxx-vnet1                       |
   | 자동 등록 사용 | 사용                               |

   > **참고:** 가상 네트워크 링크가 생성될 때까지 기다리십시오. 이 작업은 1분 미만 소요됩니다.

6. **userxx.org** 프라이빗 DNS 영역의 **개요**를 클릭한다.

7. userxxvm01 과 userxxvm02에 대한 DNS 레코드가 **자동 등록됨**으로 나타나는 것을 확인한다.

   > **참고:** 레코드 집합 목록이 나타나지 않으면 몇 분 기다려야 합니다.

8. cloud shell 을 이용해서 userxxvm01 가상서버로 ssh 로 접근한다.

   ssh azureadmin@userxxvm01_public_ip  

9. ubuntu 에 로그인하여 

   ```
   nslookup userxxvm02.userxx.org
   ```

10. 실행 명령의 결과가 userxxvm02의 사설 IP를 포함하고 있음을 확인한다. (**10.xx.1.4**)

### 작업 6: 외부 이름 확인을 위한 Azure DNS 구성

이 작업에서는 공용 DNS 영역을 이용하여 외부 DNS 이름 확인을 구성합니다.

1. Azure 포털에서 **DNS 영역**을 찾아 선택하고, **DNS 영역** 블레이드에서 **+ 추가**를 클릭한다.

2. 다음 설정을 사용하여 DNS 영역을 구성한다. (다른 값은 기본 설정을 사용한다)

   | 설정        | 값                                        |
   | ----------- | ----------------------------------------- |
   | 구독        | 이 랩에서 사용하고 있는 Azure 구독의 이름 |
   | 리소스 그룹 | userxxRG                                  |
   | 이름        | 고유한 이름(예를들어 userxx.org)          |

   > **참고**: DNS 영역이 만들어질 때까지 기다리십시오. 이 작업은 약 2분 소요됩니다.

3. **리소스로 이동**을 클릭하여 DNS 영역 블레이드로 이동한다.

4. DNS 영역 블레이드에서 **+ 레코드 집합**을 클릭한다.

5. 다음 설정을 사용해 레코드 집합을 구성한다. (다른 값은 기본 설정을 사용한다)

   | 설정             | 값                                                           |
   | ---------------- | ------------------------------------------------------------ |
   | 이름             | userxxvm01                                                   |
   | 유형             | **A**                                                        |
   | 별칭 레코드 집합 | **아니요**                                                   |
   | TTL              | **1**                                                        |
   | TTL 단위         | **시간**                                                     |
   | IP 주소          | 이 랩의 세 번째 연습에서 확인했던 userxxvm01 의 공용 IP 주소 |

6. 다음 설정을 사용해 레코드 집합을 구성한다. (다른 값은 기본 설정을 사용한다)

   | 설정             |                                                             |
   | ---------------- | ----------------------------------------------------------- |
   | 이름             | userxxvm02                                                  |
   | 유형             | **A**                                                       |
   | 별칭 레코드 집합 | **아니요**                                                  |
   | TTL              | **1**                                                       |
   | TTL 단위         | **시간**                                                    |
   | IP 주소          | 이 랩의 세 번째 연습에서 확인했던 userxxvm02의 공용 IP 주소 |

7. DNS 영역 블레이드에서 **이름 서버 1** 엔트리를 복사한다.

8. Azure 포털에서 오른쪽 위의 아이콘을 클릭하여 **Cloud Shell**의 **PowerShell** 세션을 시작한다.

9. Cloud Shell 창에서 다음 명령을 실행하여 userxxvm02 DNS 레코드 집합의 외부 이름 확인을 테스트한다. (`[Name server 1]`을 이전 작업에서 복사한 **이름 서버 1**로 대체한다, `[contoso.org]`를 이전 작업에서 지정한 이름으로 대체한다)

   ```
   nslookup userxxvm01.[userxx.org] [Name server 1]
   ```

   

### 리소스 삭제

> **참고**: 사용하지 않는 새로 생성된 Azure 리소스를 제거하십시오. 사용하지 않는 리소스를 제거해야 예상치 못한 비용이 발생하지 않습니다.

1. Azure 포털에서 **Cloud Shell**의 **PowerShell** 세션을 시작한다.

2. 다음 명령을 실행하여 이 모듈의 실습에서 생성된 모든 리소스 그룹을 나열한다.

   ```
   Get-AzResourceGroup -Name 'userxxRG01'
   ```

3. 다음 명령을 실행하여 이 모듈의 실습에서 생성한 모든 리소스 그룹을 삭제한다.

   ```
   Get-AzResourceGroup -Name 'userxxRG' | Remove-AzResourceGroup -Force -AsJob
   ```

   > **참고**: 이 명령은 비동기적으로 실행되므로( --nowait 매개 변수로 결정됨) 동일한 Bash 세션 내에서 즉시 다른 Azure CLI 명령을 실행할 수 있지만, 리소스 그룹이 실제로 제거되기까지는 몇 분 정도 소요됩니다.

